{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceAPIVersion": {
      "type": "string",
      "metadata": {
        "description": "version for resource"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Deployment region location"
      }
    },
    "adminUserName": {
      "type": "string",
      "metadata": {
        "description": "Admin user name for the VMs"
      }
    },
    "adminPublicKey": {
      "type": "securestring",
      "metadata": {
        "description": "Admin publickey for the VMs"
      }
    },
    "adminPassword": {
      "type": "string",
      "metadata": {
        "description": "Admin user password for the VMs"
      }
    },
    "hdpVmSize": {
      "type": "string",
      "metadata": {
        "description": "Hadoop VM type"
      }
    },
    "clientVmSize": {
      "type": "string",
      "metadata": {
        "description": "Client VM type"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Unique namespace for resource group to datalake provisioning"
      }
    },
    "storageAccountPrefix": {
      "type": "string",
      "metadata": {
        "description": "Unique namespace for the Storage Account where the VM disks will be placed "
      }
    },
    "storageAccountType": {
      "type": "string",
      "metadata": {
        "description": "The type of the Storage Account"
      }
    },
    "genericNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "DNS Label for the Public IP. Must be lowercase"
      }
    },
    "dnsNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "DNS Label for the Public IP. Must be lowercase."
      }
    },
    "virtualNetworkNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Hadoop VNet name "
      }
    },
    "subnetNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Hadoop Subnet Name "
      }
    },
    "NetworkInterfaceNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Hadoop NIC name (default is datalake-NIC)"
      }
    },
    "clusterFootprint": {
      "type": "string",
      "metadata": {
        "description": "Specify either small or medium or large"
      }
    },
    "prepareDiskScript": {
      "type": "string",
      "metadata": {
        "description": "format mount and create RAID 0 script"
      }
    },
    "initHdpVMScript": {
      "type": "string",
      "metadata": {
        "description": "Perform initialization script for hadoop nodes"
      }
    },
    "initAmbariVMScript": {
      "type": "string",
      "metadata": {
        "description": "Perform initialization script for ambari node"
      }
    }
  },
  "variables": {
    "clusterSizes": {
      "small": {
        "masterNodesCount": 3,
        "dataNodesCount": 3
      },
      "medium": {
        "masterNodesCount": 3,
        "dataNodesCount": 6
      },
      "large": {
        "masterNodesCount": 3,
        "dataNodesCount": 9
      }
    },
    "currentClusterSize": "[variables('clusterSizes')[parameters('clusterFootprint')]]",
    "masterNodeCount": "[variables('currentClusterSize').masterNodesCount]",
    "dataNodeCount": "[variables('currentClusterSize').dataNodesCount]",
    "TotalHDPclusterNodes": "[add(variables('masterNodeCount'), variables('dataNodeCount'))]",
    "clientStorageAccountName": "[ concat('cli', parameters('storageAccountPrefix')) ]",
    "hdpStorageAccountName": "[concat('', parameters('storageAccountPrefix'))]",
    "vNetName": "[ concat(parameters('virtualNetworkNamePrefix'), '-1') ]",
    "subnetName": "[ concat(parameters('subnetNamePrefix'), '-1') ]",
    "clientVMPubIPName": "[ concat(parameters('genericNamePrefix'), '-publicIP') ]",
    "hdpMasterVMPubIPName": "[ concat(parameters('genericNamePrefix'), '-mnPubIP') ]",
    "hdpDatanodePubIPName": "[ concat(parameters('genericNamePrefix'), '-dnPubIP') ]",
    "clientNicName": "[ concat(parameters('NetworkInterfaceNamePrefix'), '-client') ]",
    "hdpMasternodeNicName": "[ concat(parameters('NetworkInterfaceNamePrefix'), '-mn') ]",
    "hdpDatanodeNicName": "[ concat(parameters('NetworkInterfaceNamePrefix'), '-dn') ]",
    "vnetRef": "[resourceId('Microsoft.Network/virtualNetworks', variables('vNetName') ) ]",
    "subnetRef": "[concat(variables('vnetRef'),'/subnets/', variables('subnetName') ) ]",
    "hdpSecurityGroupName": "[ concat(parameters('subnetNamePrefix'), '-secGrp') ]",
    "clientVMName": "edgenode",
    "clientVMOSDiskName": "osDiskforDataLakeClient",
    "clientVMDataDiskName": "dataDiskforDataLakeClient",
    "hdpMasterVMName": "masternode",
    "hdpDatanodeVMName": "datanode",
    "dataDiskSize": 1023,
    "clientVMInstallScriptUri": "[parameters('initAmbariVMScript')]",
    "mnVMInstallScriptUri": "[parameters('initHdpVMScript')]",
    "mnVMPrepareDisksUri": "[parameters('prepareDiskScript')]",
    "dnVMInstallScriptUri": "[parameters('initHdpVMScript')]",
    "dnVMPrepareDisksUri": "[parameters('prepareDiskScript')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('clientStorageAccountName')]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "accountType": "[parameters('storageAccountType')]"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[concat(variables('hdpStorageAccountName'), copyIndex())]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "storageAccountLoop",
        "count": "[variables('TotalHDPclusterNodes')]"
      },
      "properties": {
        "accountType": "[parameters('storageAccountType')]"
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[ variables('vNetName') ]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "subnets": [
          {
            "name": "[ variables('subnetName') ]",
            "properties": {
              "addressPrefix": "10.0.0.0/24"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[ variables('clientVMPubIPName') ]",
      "apiVersion": "[ parameters('resourceAPIVersion') ]",
      "location": "[ resourceGroup().location ]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[ concat(parameters('dnsNamePrefix'), 'client') ]"
        }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[ variables('clientNicName') ]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('clientVMPubIPName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', variables('vNetName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAddress": "10.0.0.4",
              "privateIPAllocationMethod": "Static",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('clientVMPubIPName')) ]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('hdpSecurityGroupName')]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
            "name": "ssh_rule",
            "properties": {
              "description": "Allow SSH",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "WebHDFS",
            "properties": {
              "description": "Allow WebHDFS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "50070",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          },
          {
            "name": "Accumulo",
            "properties": {
              "description": "Allow Accumulo",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "50095",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 102,
              "direction": "Inbound"
            }
          },
          {
            "name": "Datanode",
            "properties": {
              "description": "Allow Datanode",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "50075",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 103,
              "direction": "Inbound"
            }
          },
          {
            "name": "Falcon",
            "properties": {
              "description": "Allow Falcon",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "15000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 104,
              "direction": "Inbound"
            }
          },
          {
            "name": "HBaseMaster",
            "properties": {
              "description": "Allow HBaseMaster",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "16000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 105,
              "direction": "Inbound"
            }
          },
          {
            "name": "HBaseRegion",
            "properties": {
              "description": "Allow HBaseRegion",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "16020",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 106,
              "direction": "Inbound"
            }
          },
          {
            "name": "HS2",
            "properties": {
              "description": "Allow HS2",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "50070",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 107,
              "direction": "Inbound"
            }
          },
          {
            "name": "HS2Http",
            "properties": {
              "description": "Allow HS2Http",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "10001",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 108,
              "direction": "Inbound"
            }
          },
          {
            "name": "JobHistory",
            "properties": {
              "description": "Allow JobHistory",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "19888",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 109,
              "direction": "Inbound"
            }
          },
          {
            "name": "Knox",
            "properties": {
              "description": "Allow Knox",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8443",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 110,
              "direction": "Inbound"
            }
          },
          {
            "name": "Oozie",
            "properties": {
              "description": "Allow Oozie",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "11000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 111,
              "direction": "Inbound"
            }
          },
          {
            "name": "ResourceManager",
            "properties": {
              "description": "Allow ResourceManager",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8050",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 113,
              "direction": "Inbound"
            }
          },
          {
            "name": "SOLR",
            "properties": {
              "description": "Allow SOLR",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8993",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 114,
              "direction": "Inbound"
            }
          },
          {
            "name": "StormUI",
            "properties": {
              "description": "Allow StormUI",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8744",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 115,
              "direction": "Inbound"
            }
          },
          {
            "name": "WebHBase",
            "properties": {
              "description": "Allow WebHBase",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "60080",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 116,
              "direction": "Inbound"
            }
          },
          {
            "name": "WebHCat",
            "properties": {
              "description": "Allow WebHCat",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "50111",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 117,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerAdmin",
            "properties": {
              "description": "Allow Ranger Admin",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6080",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 118,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnRM",
            "properties": {
              "description": "Allow YarnRM",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8088",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 119,
              "direction": "Inbound"
            }
          },
          {
            "name": "Ambari",
            "properties": {
              "description": "Allow Ambari",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8080",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 120,
              "direction": "Inbound"
            }
          },
          {
            "name": "HDFS",
            "properties": {
              "description": "Allow HDFS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8020",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 121,
              "direction": "Inbound"
            }
          },
          {
            "name": "NFS",
            "properties": {
              "description": "Allow NFS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "111",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 122,
              "direction": "Inbound"
            }
          },
          {
            "name": "NodeManager",
            "properties": {
              "description": "Allow NodeManager",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8040",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 123,
              "direction": "Inbound"
            }
          },
          {
            "name": "AmbariShell",
            "properties": {
              "description": "Allow AmbariShell",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "4200",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 124,
              "direction": "Inbound"
            }
          },
          {
            "name": "Atlas",
            "properties": {
              "description": "Allow Atlas",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "21000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 125,
              "direction": "Inbound"
            }
          },
          {
            "name": "HST",
            "properties": {
              "description": "Allow HST",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 126,
              "direction": "Inbound"
            }
          },
          {
            "name": "solrAdmin",
            "properties": {
              "description": "Allow solrAdmin",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8983",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 127,
              "direction": "Inbound"
            }
          },
          {
            "name": "Spark",
            "properties": {
              "description": "Allow Spark",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "4040",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 128,
              "direction": "Inbound"
            }
          },
          {
            "name": "SparkHistServer",
            "properties": {
              "description": "Allow SparkHistServer",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "18080",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 129,
              "direction": "Inbound"
            }
          },
          {
            "name": "Zeppelin",
            "properties": {
              "description": "Allow Zeppelin",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9995",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 130,
              "direction": "Inbound"
            }
          },
          {
            "name": "HMasterWebUI",
            "properties": {
              "description": "Allow HMaster Web UI",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "16010",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 131,
              "direction": "Inbound"
            }
          },
          {
            "name": "HBaseRegionServer2",
            "properties": {
              "description": "Allow HBase Region Server 2",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "16030",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 132,
              "direction": "Inbound"
            }
          },
          {
            "name": "StormJMXRemote",
            "properties": {
              "description": "Allow Storm JMX Remote",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "56431",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 133,
              "direction": "Inbound"
            }
          },
          {
            "name": "ZookeeperServerPort2",
            "properties": {
              "description": "Allow ZK Port 2",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "2888",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 134,
              "direction": "Inbound"
            }
          },
          {
            "name": "ZookeeperServerPort3",
            "properties": {
              "description": "Allow ZK Port 3",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3888",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 135,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnRMPort2",
            "properties": {
              "description": "Allow Yarn RM Port 2",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8025",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 136,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnScheduler",
            "properties": {
              "description": "Allow Yarn Scheduler Access",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8030",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 137,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnScheduler2",
            "properties": {
              "description": "Allow Yarn Scheduler",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8141",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 138,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnTimelineServer",
            "properties": {
              "description": "Allow Yarn TS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "10200",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 139,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnTimelineServerPort2",
            "properties": {
              "description": "Allow Yarn TS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8188",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 140,
              "direction": "Inbound"
            }
          },
          {
            "name": "YarnTimelineServerPort3",
            "properties": {
              "description": "Allow Yarn TS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8190",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 141,
              "direction": "Inbound"
            }
          },
          {
            "name": "TezAM",
            "properties": {
              "description": "Allow Tez App Master",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "12999",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 142,
              "direction": "Inbound"
            }
          },
          {
            "name": "TezService",
            "properties": {
              "description": "Allow Tez Service",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "10030",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 143,
              "direction": "Inbound"
            }
          },
          {
            "name": "StormDRPC",
            "properties": {
              "description": "Allow Storm DRPC",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3772",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 144,
              "direction": "Inbound"
            }
          },
          {
            "name": "StormDRPCInvocation",
            "properties": {
              "description": "Allow Storm DRPC Invocation",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3773",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 145,
              "direction": "Inbound"
            }
          },
          {
            "name": "NimbusThriftPort",
            "properties": {
              "description": "Allow Nimbus Thrift",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6627",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 146,
              "direction": "Inbound"
            }
          },
          {
            "name": "StormLogViewer",
            "properties": {
              "description": "Allow Storm Log Viewer",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 147,
              "direction": "Inbound"
            }
          },
          {
            "name": "SparkThriftPort",
            "properties": {
              "description": "Allow Spark Thrift",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "10015",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 148,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerAdmin2",
            "properties": {
              "description": "Allow Ranger Admin 2",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6182",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 149,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerUserSync",
            "properties": {
              "description": "Allow Ranger User Sync",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "5151",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 150,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerKMS1",
            "properties": {
              "description": "Allow Ranger KMS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9292",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 151,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerKMS2",
            "properties": {
              "description": "Allow Ranger KMS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9293",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 152,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerSolr1",
            "properties": {
              "description": "Allow Solr for Ranger",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6083",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 153,
              "direction": "Inbound"
            }
          },
          {
            "name": "RangerSolr2",
            "properties": {
              "description": "Allow Solr for Ranger",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6183",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 154,
              "direction": "Inbound"
            }
          },
          {
            "name": "KerberosKDC",
            "properties": {
              "description": "Allow Kerberos KDC",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "88",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 155,
              "direction": "Inbound"
            }
          },
          {
            "name": "Hue",
            "properties": {
              "description": "Allow Hue",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "8888",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 156,
              "direction": "Inbound"
            }
          },
          {
            "name": "HiveMetastorePort",
            "properties": {
              "description": "Allow Hive MetaStore",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9083",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 157,
              "direction": "Inbound"
            }
          },
          {
            "name": "HiveServerAltPort",
            "properties": {
              "description": "Allow Alternate Hive Server",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "10000",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 158,
              "direction": "Inbound"
            }
          },
          {
            "name": "Kafka2Port",
            "properties": {
              "description": "Allow Kafka",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "6667",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 159,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[ concat( variables('hdpMasterVMPubIPName'), copyIndex() ) ]",
      "apiVersion": "[ parameters('resourceAPIVersion') ]",
      "location": "[ resourceGroup().location ]",
      "copy": {
        "name": "mnPubIpLoop",
        "count": "[variables('masterNodeCount')]"
      },
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[ concat(parameters('dnsNamePrefix'),'mn', copyIndex() )]"
        }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('hdpMasternodeNicName'), copyIndex())]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('vNetName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', variables('hdpSecurityGroupName'))]"
      ],
      "copy": {
        "name": "hdpNodeMasterNicLoop",
        "count": "[variables('masterNodeCount')]"
      },
      "properties": {
        "ipConfigurations": [
          {
            "name": "[ concat( 'ipconfig-', copyIndex() ) ]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "[ concat('10.0.0.', add(copyIndex(), 5) ) ]",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('hdpMasterVMPubIPName'), copyIndex() ) )]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('hdpSecurityGroupName'))]"
        }
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[ concat(variables('hdpDatanodePubIPName'), copyIndex() ) ]",
      "apiVersion": "[ parameters('resourceAPIVersion') ]",
      "location": "[ resourceGroup().location ]",
      "copy": {
        "name": "dnPubIpLoop",
        "count": "[variables('dataNodeCount')]"
      },
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[ concat(parameters('dnsNamePrefix'), 'dn', copyIndex()) ]"
        }
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('hdpDatanodeNicName'), copyIndex())]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('vNetName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', variables('hdpSecurityGroupName'))]"
      ],
      "copy": {
        "name": "hdpNodeNicLoop",
        "count": "[variables('dataNodeCount')]"
      },
      "properties": {
        "ipConfigurations": [
          {
            "name": "[ concat( 'ipconfig-', copyIndex() ) ]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "[ concat('10.0.0.', add(copyIndex(), 11) ) ]",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('hdpDatanodePubIPName'), copyIndex()) )]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('hdpSecurityGroupName'))]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[ variables('clientVMName') ]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[ concat( 'Microsoft.Network/networkInterfaces/', variables('clientNicName') ) ]",
        "[ concat( 'Microsoft.Storage/storageAccounts/', variables('clientStorageAccountName') ) ]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('clientVmSize') ]"
        },
        "osProfile": {
          "computerName": "[variables('clientVMName')]",
          "adminUsername": "[parameters('adminUserName')]",
          "adminPassword": "[parameters('adminPassword')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": "false",
            "ssh": {
              "publicKeys": [
                {
                  "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                  "keyData": "[parameters('adminPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "6.7",
            "version": "latest"
          },
          "osDisk": {
            "name": "[concat(variables('clientVMName'), 'osdisk')]",
            "vhd": {
              "uri": "[concat('http://',variables('clientStorageAccountName'), '.blob.core.windows.net/',variables('clientVMName'),'/',variables('clientVMOSDiskName'),'.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": [
            {
              "name": "datadisk0",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 0,
              "vhd": {
                "uri": "[concat('http://',variables('clientStorageAccountName'), '.blob.core.windows.net/',variables('clientVMName'),'/',variables('clientVMDataDiskName'),'.vhd')]"
              },
              "caching": "None",
              "createOption": "Empty"
            }
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('clientNicName') ) ]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('hdpMasterVMName'), copyIndex())]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('hdpMasternodeNicName'), copyIndex())]",
        "[concat('Microsoft.Storage/storageAccounts/', variables('hdpStorageAccountName'), copyIndex())]",
        "[concat('Microsoft.Compute/virtualMachines/', variables('clientVMName'))]"
      ],
      "copy": {
        "name": "hdpNodeNicLoop",
        "count": "[variables('masterNodeCount')]"
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('hdpVmSize') ]"
        },
        "osProfile": {
          "computerName": "[concat(variables('hdpMasterVMName'), copyIndex())]",
          "adminUsername": "[parameters('adminUserName')]",
          "adminPassword": "[parameters('adminPassword')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": "false",
            "ssh": {
              "publicKeys": [
                {
                  "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                  "keyData": "[parameters('adminPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "6.7",
            "version": "latest"
          },
          "osDisk": {
            "name": "[concat(variables('hdpMasterVMName'), copyIndex(), '-osdisk')]",
            "vhd": {
              "uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds/', variables('hdpMasterVMName'), copyIndex(), '.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": [
            {
              "name": "datadisk0",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 0,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpMasterVMName'), '-datadisk0.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk1",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 1,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpMasterVMName'), '-datadisk1.vhd')]"
              },
              "createOption": "Empty"
            }
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('hdpMasternodeNicName'), copyIndex()))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('hdpDatanodeVMName'), copyIndex())]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('hdpDatanodeNicName'), copyIndex())]",
        "[concat('Microsoft.Storage/storageAccounts/', variables('hdpStorageAccountName'), copyIndex())]",
        "[concat('Microsoft.Compute/virtualMachines/', variables('clientVMName'))]"
      ],
      "copy": {
        "name": "hdpNodeNicLoop",
        "count": "[variables('dataNodeCount')]"
      },
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('hdpVmSize') ]"
        },
        "osProfile": {
          "computerName": "[concat(variables('hdpDatanodeVMName'), copyIndex())]",
          "adminUsername": "[parameters('adminUserName')]",
          "adminPassword": "[parameters('adminPassword')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": "false",
            "ssh": {
              "publicKeys": [
                {
                  "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                  "keyData": "[parameters('adminPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "6.7",
            "version": "latest"
          },
          "osDisk": {
            "name": "[concat(variables('hdpDatanodeVMName'), copyIndex(), '-osdisk')]",
            "vhd": {
              "uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds/', variables('hdpDatanodeVMName'), copyIndex(), '.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          },
          "dataDisks": [
            {
              "name": "datadisk0",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 0,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk0.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk1",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 1,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk1.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk2",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 2,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk2.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk3",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 3,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk3.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk4",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 4,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk4.vhd')]"
              },
              "createOption": "Empty"
            },
            {
              "name": "datadisk5",
              "diskSizeGB": "[variables('dataDiskSize')]",
              "lun": 5,
              "vhd": {
                "Uri": "[concat('http://', variables('hdpStorageAccountName'), copyIndex(), '.blob.core.windows.net/vhds0/', variables('hdpDatanodeVMName'), '-datadisk5.vhd')]"
              },
              "createOption": "Empty"
            }						
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('hdpDatanodeNicName'), copyIndex()))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('clientVMName'),'/installambari')]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('clientVMName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.2",
        "settings": {
          "fileUris": [
            "[variables('clientVMInstallScriptUri')]"
          ],
          "commandToExecute": "[concat('sh Init_AmbariVM.sh ', parameters('adminUserName') , ' >> /home/', parameters('adminUserName'),'/initialize-datanode.log 2>&1')]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('hdpMasterVMName'), copyIndex(), '/initMasterVMs')]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "nameNodeNicLoop",
        "count": "[variables('masterNodeCount')]"
      },
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('hdpMasterVMName'), copyIndex())]"
      ],
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.2",
        "settings": {
          "fileUris": [
            "[variables('mnVMInstallScriptUri')]",
            "[variables('mnVMPrepareDisksUri')]"
          ],
          "commandToExecute": "[concat('sh Init_HdpVM.sh ', parameters('adminUserName') , ' >> /home/', parameters('adminUserName'),'/initialize-masternode.log 2>&1')]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('hdpDatanodeVMName'), copyIndex(), '/initDataVMs')]",
      "apiVersion": "[parameters('resourceAPIVersion')]",
      "location": "[resourceGroup().location]",
      "copy": {
        "name": "nameNodeNicLoop",
        "count": "[variables('dataNodeCount')]"
      },
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('hdpDatanodeVMName'), copyIndex())]"
      ],
      "properties": {
        "publisher": "Microsoft.OSTCExtensions",
        "type": "CustomScriptForLinux",
        "typeHandlerVersion": "1.2",
        "settings": {
          "fileUris": [
            "[variables('dnVMInstallScriptUri')]",
            "[variables('dnVMPrepareDisksUri')]"
          ],
          "commandToExecute": "[concat('sh Init_HdpVM.sh ', parameters('adminUserName') , ' >> /home/', parameters('adminUserName'),'/initialize-datanode.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {}
}